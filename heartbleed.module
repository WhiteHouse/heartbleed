<?php
/**
 * @file
 * Heartbleed module.
 */

/**
 * Implements hook_menu().
 */
function heartbleed_menu() {
  $items = array();

  $items['heartbleed'] = array(
    'page callback' => 'heartbleed_page',
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function heartbleed_menu_alter(&$items) {
  // Take over user reset so we can effectively log the event. There's no way
  // to tell otherwise (via hook_user_update) that the user is resetting their
  // password.
  $items['user/reset/%/%/%']['page callback'] = 'heartbleed_pass_reset';
}

/**
 * Implements hook_form_alter().
 */
function heartbleed_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_login' || $form_id == 'user_login_block') {
    // Add additional submit handler.
    $form['#submit'][] = 'heartbleed_login_submit';
  }
}

/**
 * Submit handler for heartbleed reset.
 *
 * Upon successful login, force logout and redirect user to /heartbleed page
 * where they will receive instructions on how to reset their password.
 */
function heartbleed_login_submit($form_id, &$form_state) {
  // Check if user needs reset.
  $force_reset = heartbleed_force_reset();
  // Copied from user_logout().
  global $user;
  watchdog('user', 'Session closed for %name.', array('%name' => $user->name));
  module_invoke_all('user_logout', $user);
  // Destroy the current session, and reset $user to the anonymous user.
  session_destroy();
  // Trick Drupal, to override destination where set.
  $_GET['destination'] = 'heartbleed';
  drupal_goto('heartbleed');

}

/**
 * Page callback for /heartbleed.
 */
function heartbleed_page() {
  drupal_set_message(t('HEARTBLEED: Check your email for a password reset link.'), 'error');
  module_load_include('inc', 'user', 'user.pages');
  return drupal_get_form('user_pass');
}

/**
 * Check if user needs to reset password.
 */
function heartbleed_force_reset() {
  global $user;

  // Assume password needs to be reset until we determine otherwise.
  $needs_reset = TRUE;

  // Default April 7, 2014.
  $rest_required_after = variable_get('heartbleed_require_reset_after', 1396828800);

  // Do we know when user last reset password?
    // If no, force reset.

  // Was pass reset after $rest_required_after?
    // If no, force reset.
    // If yes, don't force reset.
 

  return $needs_reset;
}

/**
 * Implements hook_user_update().
 */
function heartbleed_user_update(&$edit, $account, $category) {

  // Is user updating password? If so, log event in heartbleed table.
}

/**
 * Provide last password reset timestamp.
 *
 * @param int $uid
 *   User id.
 *
 * @return int|bool
 *   Timestamp for when user last reset pass if availble. False if not.
 */
function heartbleed_get_last_reset($uid) {
  $query = db_query('SELECT * FROM {heartbleed} WHERE uid = :uid', 
    array(':uid' => $uid));
  $query->exec();
  $query->fetchAssoc();
  dsm($query);
}

/**
 * Callback taking over user/reset/%/%/%.
 */
function heartbleed_pass_reset($uid, $timestamp, $hashed_pass) {
  // Use logic from user.pages.inc to verify legitimate reset request.
  $users = user_load_multiple(array($uid), array('status' => '1'));
  $account = reset($users);
  if ($hashed_pass == user_pass_rehash($account->pass, $timestamp, $account->login)) {
    
    // It's a legitimate request. Update last_reset value in heartbleed table.
  }
  // Now proceed to regular password reset page we took over from user module.
  return drupal_get_form('user_pass_reset', $uid, $timestamp, $hashed_pass);
}
